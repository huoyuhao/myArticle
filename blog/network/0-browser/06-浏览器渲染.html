<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端浏览器渲染原理</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.png">
    <meta name="description" content="前端浏览器渲染原理">
    <meta name="keywords" content="前端浏览器渲染原理,浏览器渲染,渲染过程,回流,重绘,async,defer">
    <meta name="author" content="liam">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/assets/css/0.styles.dff9313a.css" as="style"><link rel="preload" href="/assets/js/app.f6fbab6b.js" as="script"><link rel="preload" href="/assets/js/2.786abe42.js" as="script"><link rel="preload" href="/assets/js/22.ddc4c9fa.js" as="script"><link rel="prefetch" href="/assets/js/10.77e82e09.js"><link rel="prefetch" href="/assets/js/11.a5a6b5ed.js"><link rel="prefetch" href="/assets/js/12.10069527.js"><link rel="prefetch" href="/assets/js/13.8c9afe33.js"><link rel="prefetch" href="/assets/js/14.fbc62396.js"><link rel="prefetch" href="/assets/js/15.991ff191.js"><link rel="prefetch" href="/assets/js/16.d9fc00ae.js"><link rel="prefetch" href="/assets/js/17.105a5b2c.js"><link rel="prefetch" href="/assets/js/18.c8bfb14e.js"><link rel="prefetch" href="/assets/js/19.a64a6747.js"><link rel="prefetch" href="/assets/js/20.1c64489c.js"><link rel="prefetch" href="/assets/js/21.80b3605c.js"><link rel="prefetch" href="/assets/js/23.4cc3f28d.js"><link rel="prefetch" href="/assets/js/24.e6efdc19.js"><link rel="prefetch" href="/assets/js/25.b8254903.js"><link rel="prefetch" href="/assets/js/26.4ec1682c.js"><link rel="prefetch" href="/assets/js/27.26ae01c7.js"><link rel="prefetch" href="/assets/js/28.e49d96e7.js"><link rel="prefetch" href="/assets/js/29.b6301639.js"><link rel="prefetch" href="/assets/js/3.160904e0.js"><link rel="prefetch" href="/assets/js/30.a9e1cdef.js"><link rel="prefetch" href="/assets/js/31.6eceb1c5.js"><link rel="prefetch" href="/assets/js/32.b3ea7de8.js"><link rel="prefetch" href="/assets/js/33.77cbb967.js"><link rel="prefetch" href="/assets/js/34.c7b45509.js"><link rel="prefetch" href="/assets/js/35.837a7ef3.js"><link rel="prefetch" href="/assets/js/36.245c03ed.js"><link rel="prefetch" href="/assets/js/37.22c1fd93.js"><link rel="prefetch" href="/assets/js/38.3bc44b16.js"><link rel="prefetch" href="/assets/js/39.f75493b2.js"><link rel="prefetch" href="/assets/js/4.f82fedd0.js"><link rel="prefetch" href="/assets/js/40.6767b9ec.js"><link rel="prefetch" href="/assets/js/41.4a2ca088.js"><link rel="prefetch" href="/assets/js/42.4d6598da.js"><link rel="prefetch" href="/assets/js/43.3ae578c2.js"><link rel="prefetch" href="/assets/js/44.b8ea32d3.js"><link rel="prefetch" href="/assets/js/45.9aa136df.js"><link rel="prefetch" href="/assets/js/46.809da1e8.js"><link rel="prefetch" href="/assets/js/47.9b3f820a.js"><link rel="prefetch" href="/assets/js/48.bcd666f2.js"><link rel="prefetch" href="/assets/js/49.3d866923.js"><link rel="prefetch" href="/assets/js/5.16b9f8ac.js"><link rel="prefetch" href="/assets/js/50.e42926ef.js"><link rel="prefetch" href="/assets/js/51.a5377ba7.js"><link rel="prefetch" href="/assets/js/52.52e9e1aa.js"><link rel="prefetch" href="/assets/js/53.116e2dd9.js"><link rel="prefetch" href="/assets/js/54.7ed92099.js"><link rel="prefetch" href="/assets/js/55.e41b700c.js"><link rel="prefetch" href="/assets/js/56.8853e7c2.js"><link rel="prefetch" href="/assets/js/57.f0136a02.js"><link rel="prefetch" href="/assets/js/58.be33c188.js"><link rel="prefetch" href="/assets/js/59.f7a5c917.js"><link rel="prefetch" href="/assets/js/6.3c02a0c5.js"><link rel="prefetch" href="/assets/js/60.851642cb.js"><link rel="prefetch" href="/assets/js/61.1885e559.js"><link rel="prefetch" href="/assets/js/62.00eb6270.js"><link rel="prefetch" href="/assets/js/63.35638051.js"><link rel="prefetch" href="/assets/js/64.983d258a.js"><link rel="prefetch" href="/assets/js/65.34d9a389.js"><link rel="prefetch" href="/assets/js/66.b5fa3d17.js"><link rel="prefetch" href="/assets/js/67.2026d719.js"><link rel="prefetch" href="/assets/js/68.689ee670.js"><link rel="prefetch" href="/assets/js/69.ecc29dcf.js"><link rel="prefetch" href="/assets/js/7.86d7dbb1.js"><link rel="prefetch" href="/assets/js/8.f7fbd026.js"><link rel="prefetch" href="/assets/js/9.18f925aa.js">
    <link rel="stylesheet" href="/assets/css/0.styles.dff9313a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/header-logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/web/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  Frame
</a></div><div class="nav-item"><a href="/network/" class="nav-link router-link-active">
  Network
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  Other
</a></div><div class="nav-item"><a href="https://github.com/huoyuhao/myArticle" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/web/" class="nav-link">
  Web
</a></div><div class="nav-item"><a href="/frame/" class="nav-link">
  Frame
</a></div><div class="nav-item"><a href="/network/" class="nav-link router-link-active">
  Network
</a></div><div class="nav-item"><a href="/linux/" class="nav-link">
  Linux
</a></div><div class="nav-item"><a href="/other/" class="nav-link">
  Other
</a></div><div class="nav-item"><a href="https://github.com/huoyuhao/myArticle" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>browser</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/network/0-browser/01-浏览器内核.html" class="sidebar-link">浏览器内核</a></li><li><a href="/network/0-browser/02-浏览器DNS解析.html" class="sidebar-link">浏览器DNS解析</a></li><li><a href="/network/0-browser/03-DNS预解析.html" class="sidebar-link">DNS预解析</a></li><li><a href="/network/0-browser/03-跨域.html" class="sidebar-link">跨域</a></li><li><a href="/network/0-browser/04-Cookie.html" class="sidebar-link">Cookie</a></li><li><a href="/network/0-browser/05-浏览器缓存.html" class="sidebar-link">浏览器缓存</a></li><li><a href="/network/0-browser/06-浏览器渲染.html" class="active sidebar-link">浏览器渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_1-前端浏览器渲染过程" class="sidebar-link">1. 前端浏览器渲染过程</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_2-构建dom树" class="sidebar-link">2. 构建DOM树</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_3-构建cssom规则树" class="sidebar-link">3. 构建CSSOM规则树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_3-1-css-的继承和层叠" class="sidebar-link">3.1 CSS 的继承和层叠</a></li></ul></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_4-构建渲染树" class="sidebar-link">4. 构建渲染树</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_5-渲染树布局" class="sidebar-link">5. 渲染树布局</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_5-1-分层" class="sidebar-link">5.1 分层</a></li></ul></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_6-渲染树绘制" class="sidebar-link">6. 渲染树绘制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_6-1-栅格化-raster" class="sidebar-link">6.1 栅格化(raster)</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_6-2-合成和显示" class="sidebar-link">6.2 合成和显示</a></li></ul></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_7-渲染流水线总结" class="sidebar-link">7. 渲染流水线总结</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-回流与重绘" class="sidebar-link">8. 回流与重绘</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-1-重排reflow" class="sidebar-link">8.1 重排Reflow</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-2-常见引起回流-重排属性的方法" class="sidebar-link">8.2 常见引起回流/重排属性的方法</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-3-重绘repaint" class="sidebar-link">8.3 重绘Repaint</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-4-浏览器的渲染队列" class="sidebar-link">8.4 浏览器的渲染队列</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#_8-5-减少重绘重排优化" class="sidebar-link">8.5 减少重绘重排优化</a></li><li class="sidebar-sub-header"><a href="/network/0-browser/06-浏览器渲染.html#参考文献" class="sidebar-link">参考文献</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>network</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前端浏览器渲染原理"><a href="#前端浏览器渲染原理" class="header-anchor">#</a> 前端浏览器渲染原理</h1> <h2 id="_1-前端浏览器渲染过程"><a href="#_1-前端浏览器渲染过程" class="header-anchor">#</a> 1. 前端浏览器渲染过程</h2> <p>浏览器对内容的渲染，这一内容（渲染树构建、布局及绘制）主要包含下面几个部分：</p> <ul><li>解析HTML，生成DOM树（DOM）</li> <li>解析CSS，生成CSSOM树（CSSOM）</li> <li>将DOM和CSSOM合并，生成渲染树（Render-Tree）</li> <li>计算渲染树的布局（Layout）</li> <li>将布局渲染到屏幕上（Paint）</li></ul> <h2 id="_2-构建dom树"><a href="#_2-构建dom树" class="header-anchor">#</a> 2. 构建DOM树</h2> <p>当浏览器接收到服务器响应来的HTML文档后，会遍历文档节点，生成DOM树，具体过程如下图：</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8DOM%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B.png" alt="浏览器DOM构建过程"></p> <ul><li><strong>转换：</strong> 浏览器从磁盘或网络读取HTML的原始字节，并根据文件的指定编码（例如 UTF-8）将它们转换成字符串。在网络中传输的内容其实都是 0 和 1 这些字节数据。当浏览器接收到这些字节数据以后，它会将这些字节数据转换为字符串，也就是我们写的代码。</li> <li><strong>令牌化：</strong> 将字符串转换成Token，例如：<code>&lt;html&gt;、&lt;body&gt;</code>等。Token中会标识出当前Token是“开始标签”或是“结束标签”亦或是“文本”等信息</li> <li><strong>词法分析：</strong> 发出的令牌转换成定义其属性和规则的“对象”</li> <li><strong>DOM构建：</strong> 由于 HTML 标记定义不同标记之间的关系（一些标记包含在其他标记内），创建的对象链接在一个树数据结构内，此结构也会捕获原始标记中定义的父项-子项关系：HTML 对象是 body 对象的父项，body 是 paragraph 对象的父项，依此类推。</li></ul> <h2 id="_3-构建cssom规则树"><a href="#_3-构建cssom规则树" class="header-anchor">#</a> 3. 构建CSSOM规则树</h2> <p>与处理 HTML 时一样，我们需要将收到的 CSS 规则转换成某种浏览器能够理解和处理的东西。因此，我们会重复 HTML 过程，不过是为 CSS 而不是 HTML：</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8CSSOM%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B-1.png" alt="浏览器CSSOM构建过程"></p> <p>CSS 字节转换成字符，接着转换成令牌和节点，最后链接到一个称为“CSS 对象模型”(CSSOM) 的树结构内</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8CSSOM%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B-2.png" alt="浏览器CSSOM构建过程"></p> <p>浏览器解析css过程是阻塞的，浏览器需要解析完所有的css才会使用css样式(和浏览器的回流重绘一样)</p> <p>CSS它只显示了我们决定在样式表中替换的样式。每个浏览器都提供一组默认样式（也称为User Agent 样式），即我们不提供任何自定义样式时所看到的样式，我们的样式只是替换这些默认样式（<a href="http://www.iecss.com/" target="_blank" rel="noopener noreferrer">例如默认 IE 样式<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <h3 id="_3-1-css-的继承和层叠"><a href="#_3-1-css-的继承和层叠" class="header-anchor">#</a> 3.1 CSS 的继承和层叠</h3> <p><strong>层叠性</strong>
该层叠将获取给定元素上给定属性的声明值的无序列表，按声明的优先级对它们进行排序，并输出单个层叠值。</p> <p>当多个相互冲突的CSS声明应用于同一个元素时，CSS层叠算法会根据一定的机制，从最高权重到最低权重的顺序列出著作权归作者所有，具体如下：</p> <p>来源和重要性 -&gt; 选择器权重 -&gt; 出现的顺序 -&gt; 初始和继承属性（默认值）</p> <p><strong>继承性</strong>
当元素的一个继承属性没有指定值时，则取父元素的同属性的计算值。只有文档根元素取该属性的概述中给定的初始值</p> <p>color、 text-开头的、line-开头的、font-开头的样式可以被继承</p> <h2 id="_4-构建渲染树"><a href="#_4-构建渲染树" class="header-anchor">#</a> 4. 构建渲染树</h2> <p>浏览器将 DOM 和 CSSOM 合并成一个“渲染树”，网罗网页上所有可见的 DOM 内容，以及每个节点的所有 CSSOM 样式信息</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E6%A0%91%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B.png" alt="浏览器渲染树构建过程"></p> <p>为构建渲染树，浏览器大体上完成了下列工作：</p> <ol><li><p>从 DOM 树的根节点开始遍历每个可见节点</p> <ul><li>某些节点不可见（例如脚本标记、元标记等），因为它们不会体现在渲染输出中，所以会被忽略。</li> <li>某些节点通过 CSS 隐藏，因此在渲染树中也会被忽略，例如，上例中的 span 节点不会出现在渲染树中，因为有一个显式规则在该节点上设置了“display: none”属性</li></ul></li> <li><p>对于每个可见节点，为其找到适配的 CSSOM 规则并应用它们</p></li> <li><p>发射可见节点，连同其内容和计算的样式</p></li></ol> <p>请注意 visibility: hidden 与 display: none 是不一样的。前者隐藏元素，但元素仍占据着布局空间（即将其渲染成一个空框），而后者 (display: none) 将元素从渲染树中完全移除，元素既不可见，也不是布局的组成部分</p> <h2 id="_5-渲染树布局"><a href="#_5-渲染树布局" class="header-anchor">#</a> 5. 渲染树布局</h2> <p>布局阶段会从渲染树的根节点开始遍历，然后确定每个节点对象在页面上的确切大小与位置，布局阶段的输出是一个盒子模型，它会精确地捕获每个元素在屏幕内的确切位置与大小</p> <h3 id="_5-1-分层"><a href="#_5-1-分层" class="header-anchor">#</a> 5.1 分层</h3> <p>因为页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等，为了更加方便地实现这些效果，渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树</p> <ol><li><p>拥有层叠上下文属性的元素会被提升为单独的一层</p> <p><img src="/img/%E5%B1%82%E5%8F%A0%E4%B8%8A%E4%B8%8B%E6%96%87%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="层叠上下文示意图"></p> <p>从图中可以看出，明确定位属性的元素、定义透明属性的元素、使用 CSS 滤镜的元素等，都拥有层叠上下文属性</p></li> <li><p>需要剪裁（clip）的地方也会被创建为图层
需要剪裁也就是说容器内容不足以显示页面内容，出现了滚动条，渲染引擎会为这部分单独创建一个层</p></li></ol> <h2 id="_6-渲染树绘制"><a href="#_6-渲染树绘制" class="header-anchor">#</a> 6. 渲染树绘制</h2> <p>在绘制阶段，遍历渲染树，调用渲染器的paint()方法在屏幕上显示其内容。渲染树的绘制工作是由浏览器的UI后端组件完成的。</p> <p>在完成图层树的构建之后，渲染引擎会对图层树中的每个图层进行绘制</p> <h3 id="_6-1-栅格化-raster"><a href="#_6-1-栅格化-raster" class="header-anchor">#</a> 6.1 栅格化(raster)</h3> <p>要明白栅格化，先要理解什么是图块和位图。</p> <p><strong>图块(tile)</strong>
图块是渲染进程即浏览器内核当中的合成线程将图层划分为大小512x512或者256x256的区块</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E6%A0%85%E6%A0%BC%E5%8C%96-1.png" alt="浏览器渲染栅格化"></p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E6%A0%85%E6%A0%BC%E5%8C%96-2.png" alt="浏览器渲染栅格化"></p> <p><strong>位图</strong>
位图是栅格化的过程：合成线程会按照视口附近的图块来优先生成位图，实际生成位图的操作是由栅格化来执行的，将图块转换为位图。</p> <h3 id="_6-2-合成和显示"><a href="#_6-2-合成和显示" class="header-anchor">#</a> 6.2 合成和显示</h3> <p>一旦所有图块都被光栅化，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程</p> <p>浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上</p> <h2 id="_7-渲染流水线总结"><a href="#_7-渲染流水线总结" class="header-anchor">#</a> 7. 渲染流水线总结</h2> <p>从HTML到DOM、样式计算、布局、图层、绘制、光栅化、合成和显示。下面一张图是总结下这整个渲染流程</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%B8%B2%E6%9F%93%E8%BF%9B%E7%A8%8B%E6%80%BB%E7%BB%93.png" alt="浏览器渲染进程总结"></p> <ol><li>渲染进程将HTML内容转换为能够读懂的<code>DOM树</code>结构。</li> <li>渲染引擎将CSS样式表转化为浏览器可以理解的<code>styleSheets</code>，计算出DOM节点的样式。</li> <li>创建<code>布局树</code>，并计算元素的布局信息。</li> <li>对布局树进行分层，并生成<code>分层树</code>。</li> <li>为每个图层生成<code>绘制列表</code>，并将其提交到合成线程。</li> <li>合成线程将图层分成<code>图块</code>，并在光栅化线程池中将图块转换成位图。</li> <li>合成线程发送绘制图块命令<code>DrawQuad</code>给浏览器进程。</li> <li>浏览器进程根据DrawQuad消息生成页面，并<code>显示</code>到显示器上。</li></ol> <h2 id="_8-回流与重绘"><a href="#_8-回流与重绘" class="header-anchor">#</a> 8. 回流与重绘</h2> <h3 id="_8-1-重排reflow"><a href="#_8-1-重排reflow" class="header-anchor">#</a> 8.1 重排Reflow</h3> <p>意味着元件的几何尺寸变了，我们需要重新验证并计算Render Tree。是Render Tree的一部分或全部发生了变化。这就是Reflow，或是Layout</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E9%87%8D%E6%8E%92.png" alt="重排"></p> <p>从上图可以看出，如果你通过 JavaScript 或者 CSS 修改元素的几何位置属性，例如改变元素的宽度、高度等，那么浏览器会触发重新布局，解析之后的一系列子阶段，这个过程就叫重排。无疑，<strong>重排需要更新完整的渲染流水线，所以开销也是最大的。</strong></p> <h3 id="_8-2-常见引起回流-重排属性的方法"><a href="#_8-2-常见引起回流-重排属性的方法" class="header-anchor">#</a> 8.2 常见引起回流/重排属性的方法</h3> <ul><li><p>添加或者删除可见的DOM元素</p></li> <li><p>元素尺寸改变——边距、填充、边框、宽度和高度</p></li> <li><p>内容变化，比如用户在input框中输入文字</p></li> <li><p>浏览器窗口尺寸改变——resize事件发生时</p></li> <li><p>计算 offsetWidth 和 offsetHeight 属性</p></li> <li><p>设置 style 属性的值</p></li></ul> <p>具体内容如下</p> <ul><li>width/height</li> <li>margin/padding/border</li> <li>display/position/overflow</li> <li>clientWidth/clientHeight</li> <li>clientTop/clientLeft</li> <li>offsetWidth/offsetHeight</li> <li>offsetTop/offsetLeft</li> <li>scrollWidth/scrollHeight</li> <li>scrollTop/scrollLeft</li> <li>scrollIntoView()</li> <li>scrollTo()</li> <li>getComputedStyle()</li> <li>getBoundingClientRect()</li> <li>scrollIntoViewIfNeeded()</li></ul> <h3 id="_8-3-重绘repaint"><a href="#_8-3-重绘repaint" class="header-anchor">#</a> 8.3 重绘Repaint</h3> <p>当一个元素的外观发生改变，但没有改变布局，重新把元素外观绘制出来的过程，叫做重绘</p> <p><img src="/img/%E6%B5%8F%E8%A7%88%E5%99%A8%E9%87%8D%E7%BB%98.png" alt="重绘">
从图中可以看出，如果修改了元素的背景颜色，那么布局阶段将不会被执行，因为并没有引起几何位置的变换，所以就直接进入了绘制阶段，然后执行之后的一系列子阶段，这个过程就叫重绘。<strong>相较于重排操作，重绘省去了布局和分层阶段，所以执行效率会比重排操作要高一些。</strong></p> <p>常见引起重绘属性的方法</p> <ul><li>visibility</li> <li>color</li> <li>border-style/border-radius</li> <li>background/background-image/background-position/background-repeat/background-size</li> <li>text-decoration</li> <li>outline-color/outline/outline-style/outline-width</li> <li>box-shadow</li></ul> <h3 id="_8-4-浏览器的渲染队列"><a href="#_8-4-浏览器的渲染队列" class="header-anchor">#</a> 8.4 浏览器的渲染队列</h3> <p>当我们修改了元素的几何属性，导致浏览器触发重排或重绘时。它会把该操作放进渲染队列，等到队列中的操作到了一定的数量或者到了一定的时间间隔时，浏览器就会批量执行这些操作</p> <p><strong>强制刷新队列</strong>
因为队列中，可能会有影响到这些值的操作，为了给我们最精确的值，浏览器会立即重排+重绘</p> <p>强制刷新队列的style样式请求：
<code>offsetTop</code>、<code>offsetLeft</code>、<code>offsetWidth</code>、<code>offsetHeight、</code> <code>scrollTop</code>、<code>scrollLeft</code>、<code>scrollWidth</code>、<code>scrollHeight</code> <code>clientTop</code>、<code>clientLeft</code>、<code>clientWidth</code>、<code>clientHeight</code> <code>getComputedStyle()</code>， 或者 IE的 <code>currentStyle</code></p> <p>我们在开发中，应该谨慎的使用这些style请求，注意上下文关系，避免一行代码一个重排，这对性能是个巨大的消耗</p> <h3 id="_8-5-减少重绘重排优化"><a href="#_8-5-减少重绘重排优化" class="header-anchor">#</a> 8.5 减少重绘重排优化</h3> <ol><li>分离读写操作</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// bad 4次重排+重绘</span>
div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">'10px'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">)</span>
div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token string">'10px'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>offsetTop<span class="token punctuation">)</span>
<span class="token comment">// good 一次重排</span>
div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token string">'10px'</span>
div<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token string">'10px'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>offsetLeft<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>div<span class="token punctuation">.</span>offsetTop<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="2"><li>样式集中改变</li></ol> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// bad</span>
<span class="token keyword">var</span> left <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">var</span> top <span class="token operator">=</span> <span class="token number">10</span>
el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span>
el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top  <span class="token operator">=</span> top  <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span>
<span class="token comment">// good</span>
el<span class="token punctuation">.</span>className <span class="token operator">+=</span> <span class="token string">&quot;className&quot;</span>
<span class="token comment">// good</span>
el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">+=</span> <span class="token string">&quot;; left: &quot;</span> <span class="token operator">+</span> left <span class="token operator">+</span> <span class="token string">&quot;px; top: &quot;</span> <span class="token operator">+</span> top <span class="token operator">+</span> <span class="token string">&quot;px;&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><ol start="3"><li>离线改变dom</li></ol> <ul><li>隐藏要操作的dom</li></ul> <p>在要操作dom之前，通过display隐藏dom，当操作完成之后，才将元素的display属性为可见，因为不可见的元素不会触发重排和重绘</p> <ul><li>将原始元素拷贝到一个脱离文档的节点中，修改节点后，再替换原始的元素</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> ul <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'list'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> clone <span class="token operator">=</span> ul<span class="token punctuation">.</span><span class="token function">cloneNode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token function">appendDataToElement</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
ul<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">replaceChild</span><span class="token punctuation">(</span>clone<span class="token punctuation">,</span> ul<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol start="4"><li>避免触发同步布局事件</li></ol> <p>当我们访问元素的一些属性的时候，会导致浏览器强制清空队列，强制刷新队列，所以避免使用这些属性</p> <ol start="5"><li>对于复杂动画效果，使用绝对定位让其脱离文档流</li></ol> <p>对于复杂动画效果，由于会经常的引起回流重绘，因此，我们可以使用绝对定位，让它脱离文档流。否则会引起父元素以及后续元素频繁的回流</p> <h3 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h3> <p><a href="https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-cn" target="_blank" rel="noopener noreferrer">渲染树构建、布局及绘制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5a8e242c5188257a6b060000" target="_blank" rel="noopener noreferrer">十分钟读懂浏览器渲染流程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.51cto.com/art/201810/585450.htm" target="_blank" rel="noopener noreferrer">图解Chrome：HTML/CSS/JS是如何在浏览器中，渲染成你看到的页面？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6844903623583891469" target="_blank" rel="noopener noreferrer">再谈 load 与 DOMContentLoaded<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/27/2022, 10:33:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/network/0-browser/05-浏览器缓存.html" class="prev">
        浏览器缓存
      </a></span> <span class="next"><a href="/network/1-network/01-TCP与UDP协议.html">
        TCP与UDP协议
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f6fbab6b.js" defer></script><script src="/assets/js/2.786abe42.js" defer></script><script src="/assets/js/22.ddc4c9fa.js" defer></script>
  </body>
</html>
