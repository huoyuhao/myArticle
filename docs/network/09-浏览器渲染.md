---
meta:
  - name: description
    content: 前端浏览器渲染原理
  - name: keywords
    content: 前端浏览器渲染原理,浏览器渲染,渲染过程,回流,重绘,async,defer
---
# 前端浏览器渲染原理



## 前端浏览器渲染过程
浏览器对内容的渲染，这一内容（渲染树构建、布局及绘制）主要包含下面几个部分：

+ 解析HTML，生成DOM树（DOM）

+ 解析CSS，生成CSSOM树（CSSOM）

+ 将DOM和CSSOM合并，生成渲染树（Render-Tree）

+ 计算渲染树的布局（Layout）

+ 将布局渲染到屏幕上（Paint）






## 构建DOM树
当浏览器接收到服务器响应来的HTML文档后，会遍历文档节点，生成DOM树，具体过程如下图：

![浏览器DOM构建过程](/img/浏览器DOM构建过程.png)


+ **转换：** 浏览器从磁盘或网络读取HTML的原始字节，并根据文件的指定编码（例如 UTF-8）将它们转换成字符串。在网络中传输的内容其实都是 0 和 1 这些字节数据。当浏览器接收到这些字节数据以后，它会将这些字节数据转换为字符串，也就是我们写的代码。

+ **令牌化：** 将字符串转换成Token，例如：`<html>、<body>`等。Token中会标识出当前Token是“开始标签”或是“结束标签”亦或是“文本”等信息

+ **词法分析：** 发出的令牌转换成定义其属性和规则的“对象”

+ **DOM构建：** 由于 HTML 标记定义不同标记之间的关系（一些标记包含在其他标记内），创建的对象链接在一个树数据结构内，此结构也会捕获原始标记中定义的父项-子项关系：HTML 对象是 body 对象的父项，body 是 paragraph 对象的父项，依此类推。








## 构建CSSOM规则树
与处理 HTML 时一样，我们需要将收到的 CSS 规则转换成某种浏览器能够理解和处理的东西。因此，我们会重复 HTML 过程，不过是为 CSS 而不是 HTML：

![浏览器CSSOM构建过程](/img/浏览器CSSOM构建过程-1.png)

CSS 字节转换成字符，接着转换成令牌和节点，最后链接到一个称为“CSS 对象模型”(CSSOM) 的树结构内

![浏览器CSSOM构建过程g](/img/浏览器CSSOM构建过程-2.png)

**浏览器解析css过程是阻塞的，浏览器需要解析完所有的css才会使用css样式(和浏览器的回流重绘一样)**

:::tip
CSS它只显示了我们决定在样式表中替换的样式。每个浏览器都提供一组默认样式（也称为User Agent 样式），即我们不提供任何自定义样式时所看到的样式，我们的样式只是替换这些默认样式（[例如默认 IE 样式](http://www.iecss.com/)）
:::

### CSS 的继承和层叠

**层叠性**
该层叠将获取给定元素上给定属性的声明值的无序列表，按声明的优先级对它们进行排序，并输出单个层叠值。

当多个相互冲突的CSS声明应用于同一个元素时，CSS层叠算法会根据一定的机制，从最高权重到最低权重的顺序列出著作权归作者所有，具体如下：

来源和重要性 -> 选择器权重 -> 出现的顺序 -> 初始和继承属性（默认值）
** 继承性**
当元素的一个继承属性没有指定值时，则取父元素的同属性的计算值。只有文档根元素取该属性的概述中给定的初始值

color、 text-开头的、line-开头的、font-开头的样式可以被继承








## 构建渲染树
浏览器将 DOM 和 CSSOM 合并成一个“渲染树”，网罗网页上所有可见的 DOM 内容，以及每个节点的所有 CSSOM 样式信息

![浏览器渲染树构建过程](/img/浏览器渲染树构建过程.png)

为构建渲染树，浏览器大体上完成了下列工作：
1. 从 DOM 树的根节点开始遍历每个可见节点
  + 某些节点不可见（例如脚本标记、元标记等），因为它们不会体现在渲染输出中，所以会被忽略。
  + 某些节点通过 CSS 隐藏，因此在渲染树中也会被忽略，例如，上例中的 span 节点不会出现在渲染树中，因为有一个显式规则在该节点上设置了“display: none”属性

2. 对于每个可见节点，为其找到适配的 CSSOM 规则并应用它们

3. 发射可见节点，连同其内容和计算的样式

::: warning
请注意 visibility: hidden 与 display: none 是不一样的。前者隐藏元素，但元素仍占据着布局空间（即将其渲染成一个空框），而后者 (display: none) 将元素从渲染树中完全移除，元素既不可见，也不是布局的组成部分
:::







## 渲染树布局








## 渲染树绘制








## defer与async








## 回流与重绘








## 渲染阻塞
### Js资源阻塞DOM树构建
当浏览器遇到一个 script 标记时，DOM 构建将暂停，直至脚本下载并完成执行，然后继续构建DOM。

### css加载不会阻塞DOM树的解析，但会阻塞DOM树的渲染

### css加载会阻塞后面js语句的执行


因为JavaScript不只是可以改DOM，它还可以更改样式，也就是它可以更改CSSOM。前面我们介绍，不完整的CSSOM是无法使用的，但JavaScript中想访问CSSOM并更改它，那么在执行JavaScript时，必须要能拿到完整的CSSOM。所以就导致了一个现象，如果浏览器尚未完成CSSOM的下载和构建，而我们却想在此时运行脚本，那么浏览器将延迟脚本执行和DOM构建，直至其完成CSSOM的下载和构建。也就是说，在这种情况下，浏览器会先下载和构建CSSOM，然后再执行JavaScript，最后在继续构建DOM。


### 参考文献
[渲染树构建、布局及绘制](https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-cn)

[十分钟读懂浏览器渲染流程](https://juejin.im/post/5a8e242c5188257a6b060000)